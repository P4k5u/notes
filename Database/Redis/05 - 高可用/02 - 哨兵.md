### 简介
由于主从模式是读写分离的，如果主节点（master）挂了，那就没有主节点来服务客户端的写操作请求，也没有主节点给从节点（slave）进行数据同步

当然，可以通过人工的方式将从节点切换为主节点，但这样效率太低了

Redis 2.8 之后提供了哨兵机制，作用是实现主从节点故障转移，它会监测主节点是否存活，如果发现主节点挂了，它就会选举一个从节点切换为主节点，并且把新主节点的相关信息通知给从节点和客户端。

哨兵主要功能：
- **监控**：哨兵会不断地检查主节点和从节点是否运作正常
- **自动故障转移**：当主节点不能正常工作时，哨兵会开始自动故障转移操作，将从节点升级为主节点
- **配置提供者**：客户端在初始化时可以通过连接哨兵来获得当前Redis服务的主节点地址
- **通知**：将故障转移的结果发送给客户端

### 监控
哨兵每隔 1 秒就会给所有的主从节点发送 PING 命令，当主从节点收到 PING 命令后，会发送一个响应命令给哨兵，这样就可以判断它们是否在正常工作![[Pasted image 20231121172123.png]]

#### 主观下线
如果主节点或从节点没有在规定时间内响应哨兵的 PING 命令，哨兵就会将它们标记为 主观下线。这个 规定的时间 是配置项 `down-after-milliseconds` 参数设定的，单位是毫秒

#### 客观下线
客观下线只适用于主节点。
针对主节点设计 主观下线 和 客观下线 两个状态，是因为 主节点 有可能并没有发生故障，仅仅是因为网络堵塞或压力较大而导致没有及时响应哨兵的 PING 命令

为了减少误判的情况，哨兵在部署的时候不会只部署一个节点，而是用多个节点部署成哨兵集群（最少需要三台机器来部署），通过多个哨兵节点一起判断，就可以避免单个哨兵因为自身原因而误判主节点下线的情况

##### 怎么判断主节点客观下线
当一个哨兵判断主节点为 主观下线 后，就会向其他哨兵发起命令，其他哨兵收到这个命令后，就会根据自身和主节点的网络状况，做出赞成投票或者拒绝投票的响应![[Pasted image 20231121174348.png]]
当这个哨兵的赞同票达到哨兵配置文件中 quorum 配置项设定的值后，该主节点就被标记成 客观下线
#### 哨兵集群 leader
为了进行 客观下线 的判断，哨兵往往以集群的方式部署，那么应该由集群中的哪个节点来进行 主从故障转移 呢？这时候得从哨兵集群中选出一个 leader 来执行
##### 候选者
选举 leader 的过程是一个投票的过程，在投票开始前，得有 候选者
哪个哨兵节点判断主节点为「客观下线」，这个哨兵节点就是候选者

比如：有三个哨兵。当哨兵 B 先判断到主节点「主观下线后」，就会给其他实例发送 is-master-down-by-addr 命令。接着，其他哨兵会根据自己和主节点的网络连接情况，做出赞成投票或者拒绝投票的响应![[Pasted image 20231121174827.png]]
当哨兵 B 收到赞成票数达到哨兵配置文件中的 quorum 配置项设定的值后，就会将主节点标记为「客观下线」，此时的哨兵 B 就是一个 leader 候选者
##### 选举 leader
哨兵的选举机制其实就是 Raft 选举算法

候选者会向其他哨兵发送命令，表明希望成为 leader 来执行主从切换，并让所有其他哨兵对它进行投票。

每个哨兵只有一次投票机会，如果用完后就不能参与投票了，可以投给自己或投给别人，但是只有候选者才能把票投给自己

那么在投票过程中，任何一个「候选者」，要满足两个条件：
- 拿到半数以上的赞成票
- 票数大于等于哨兵配置文件中的 `quorum` 值

**quorum 的值建议设置为哨兵个数的二分之一加 1 ，且数量为奇数**
### 故障转移
在哨兵集群中通过投票的方式，选举出了哨兵 leader 后，就可以进行主从故障转移

主从故障转移一般包含四个步骤：
- 选主：在已下线主节点（旧主节点）属下的所有「从节点」里面，挑选出一个从节点，并将其转换为主节点
- 易主：让已下线主节点属下的所有「从节点」修改复制目标，修改为复制「新主节点」
- 通知客户端：将新主节点的 IP 地址和信息，通过「发布者/订阅者机制」通知给客户端
- 下台：继续监视旧主节点，当这个旧主节点重新上线时，将它设置为新主节点的从节点
#### 选主
在下线主节点的从节点里，找出一个状态良好的从节点，发送 `SLAVE OF no one` 命令来将其转换为主节点
##### 选择条件
- 网络状态
根据 `down-after-milliseconds * 10` 配置项，其 `down-after-milliseconds` 是主从节点断连的最大连接超时时间，如果断连次数超过 10 次，那么就说明这个从节点网络不好，不适合作为主节点
- 优先级
根据 `slave-priority` 配置项，可以给从节点设置优先级。
可以根据服务器的配置来设置相关优先级
- 复制进度
在优先级一致的情况下，就会比较从节点的复制进度，在主从复制中提及的 slave_repl_offset 记录，看谁的offset最接近主节点的 master_repl_offset ，就说明他的进度是靠前的
- ID 号
当优先级和复制进度一样时，就比较从节点的 ID 号，ID 号比较小的就胜出

选出合适的从节点之后，哨兵 leader 就会向该从节点发送 `SLAVE OF no one` 命令，让这个从节点接触从节点身份，变成主节点。
然后以每秒一次的频率向升级的从节点发送 INFO 命令，观察是否升级成功

#### 易主
当新的主节点就位之后，哨兵 leader 就要把以前的 从节点 指向 新的主节点 ，通过向 从节点 发送 `SLAVE OF` 命令来实现

#### 通知客户端
通知客户端主要通过 Redis 的发布者/订阅者机制来实现，哨兵提供的消息订阅频道有很多，不同频道包含了主从节点切换过程中的不同关键事件：![[Pasted image 20231123162153.png]]

完成主从切换的工作之后，哨兵就会向 `+switch-master` 频道发布新主节点的 IP 地址和端口的消息，这个时候客户端就可以收到这条消息，就可以跟新主节点进行通信了
#### 下台
故障转移操作最后要做的是，继续监视旧主节点，当旧主节点重新上线时，哨兵集群就会向它发送 `SLAVE OF` 命令，让它成为新主节点的从节点

### 哨兵集群
在主从集群中，主节点上有一个名为 `__sentinel__:hello` 的频道，不同的哨兵就是通过它来相互发现，实现互相通信的。

通过命令设置主节点名字、主节点IP和端口号以及 quorum 值：
``` shell
sentinel monitor <master-name> <ip> <redis-port> <quorum> 
```

**哨兵节点之间是通过 Redis 的发布者/订阅者机制来相互发现的**

哨兵 1 把自己的 IP（172.16.19.3）和端口（26579）发布到`__sentinel__:hello`频道上，哨兵 2 和 3 订阅了该频道。那么此时，哨兵 2 和 3 就可以从这个频道直接获取哨兵 1 的 IP 地址和端口号。然后，哨兵 2、3 可以和哨兵 1 建立网络连接![[Pasted image 20231123163502.png]]