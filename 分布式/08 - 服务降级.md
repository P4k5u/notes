### 简介
由于爆炸性的流量冲击，对一些服务进行有策略的放弃，以此缓解系统压力，保证目前主要业务的正常运行。它主要是针对非正常情况喜爱的应急服务措施：当此时一些服务无法执行时，给出一个统一的返回结果
### 降级服务的特征
- 原因：整体负荷超出整体负载承受能力
- 目的：保证重要或基本服务正常运行，非重要服务延迟使用或暂停使用
- 大小：降低服务粒度，要考虑整体模块粒度的大小，将粒度控制在合适的范围内
- 可控性：在服务粒度大小的基础上增加服务的可控性，后台服务开关的功能是一项必要配置（单机可配置文件，其它可用数据库或缓存）
- 次序：一般从外围延伸服务开始降级，需要有一定的配置项，重要性低的优先降级
### 降级方式
- 延迟服务：比如发表了评论，重要服务，比如在文章中显示正常，但是延迟给用户增加积分，只是放到一个缓存中，等服务平稳之后再执行
- 在粒度范围内关闭服务（片段降级或服务功能降级）：比如关闭相关文章的推荐，直接关闭推荐区
- 页面异步请求降级：比如商品详情页上有推荐信息/配送至等异步加载的请求，如果这些信息响应慢或者后端服务有问题，可以进行降级
- 页面跳转（页面降级）：比如可以有相关文章推荐，但是更多的页面则直接跳转到某一个地址
- 写降级：比如秒杀抢购，我们可以只进行Cache的更新，然后异步同步扣减库存到DB，保证最终一致性即可，此时可以将DB降级为Cache
- 读降级：比如多级缓存模式，如果后端服务有问题，可以降级为只读缓存，这种方式适用于对读一致性要求不高的场景

### 降级预案
在进行降级之前要对系统进行梳理，看看系统是不是可以丢卒保帅；从而梳理哪些必须保护，哪些可以舍弃，比如可以参考日志级别设置预案：
- 一般：比如有些服务偶尔因为网络抖动或者服务正在上线而超时，可以自动降级
- 警告：有些服务在一段时间内成功率有波动，可以自动降级或人工降级，并发送告警
- 错误：比如可用率低于90%，或者数据库连接池被打爆了，或者访问量突然猛增到系统能承受的最大阈值，此时可以根据情况自动降级或人工降级
- 严重错误：比如因为特殊原因数据错误了，此时需要人工降级
### 服务降级分类
#### 根据降级的开关位置
	 根据降级的开关位置，分为服务代码降级和开关前置降级。
	 前置降级就是把降级开关放到http请求链路层的上游，降低链路层消耗。比如提升到Nginx，甚至可以提升到前端，当提升到前端时，后端访问压力接近于0![[Pasted image 20231108224443.png]]
#### 根据读写
1. 读降级
	比如读取动态数据，降级为读取静态数据![[Pasted image 20231108224553.png]]
2. 写降级
	比如写入MySQL，降级为写入消息队列或Redis，等高峰期过后，再从MQ或Redis写入MySQL，注意的是，写降级仅针对不重要、实时性不高且不涉及钱的业务![[Pasted image 20231108224758.png]]
####  根据降级的性质
根据降级的性质，分为返回内容降级，限流降级，限速降级
 - 返回内容降级：返回实时数据，降级为返回兜底数据
- 限流降级：1000个请求，变成直接受500个
- 限速降级：访问过于频繁的ip进行限速
#### 根据降级的维护特点
分为手动降级和自动降级
- 手动降级：是人为看到系统负载异常后，手动调整降级（秒杀、电商大促等）
- 自动降级：是系统检测到异常后，自动降级（超时、失败次数、故障、限流）
### 服务降级需要考虑的问题
- 核心服务或非核心服务
- 是否支持降级
- 业务放通场景